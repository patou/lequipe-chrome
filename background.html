<html>
<head>
<script type="text/javascript" src="jquery-1.4.2.js"></script>
<script type="text/javascript">
var db;
var log = document.getElementById('db-log');
// The XMLHttpRequest object that tries to load and parse the feed.
var req = false;
  
db = openDatabase("Equipe.fr", "1.0", "Items database", 200000);

function onError(tx, error) {
  console.log(error.message);
}

// select all records and display them
function showRecords() {
  document.getElementById('db_results').innerHTML = '';
  db.transaction(function(tx) {
    tx.executeSql("SELECT * FROM Items", [], function(tx, result) {
      for (var i = 0, item = null; i < result.rows.length; i++) {
        item = result.rows.item(i);
        document.getElementById('db_results').innerHTML += 
            '<li><span contenteditable="true" onkeyup="updateRecord('+item['id']+', this)">'+
            item['text'] + '</span> <a href="#" onclick="deleteRecord('+item['id']+')">[Delete]</a></li>';
      }
    });
  });
}

function createTable() {
  db.transaction(function(tx) {
    tx.executeSql("CREATE TABLE Items (id VARCHAR(255) UNIQUE, title VARCHAR(255), url VARCHAR(255), type VARCHAR(50), text TEXT, read BOOLEAN)", [],
        function(tx) {  console.log("table Items created") },
        onError);
  });
}

// add record with random values
function newRecord(id, title, url, type, text, read) {
  db.transaction(function(tx) {
    tx.executeSql("INSERT INTO Items (id, title, url, type, text, read) VALUES (?, ?, ?, ?, ?, ?)", [id, title, url, type, text, read],
        function(tx, result) {
     		console.log("Inserted");
        }, 
        onError);
  });
}

function readRecord(id, read) {
  db.transaction(function(tx) {
    tx.executeSql("UPDATE Items SET read = ? WHERE id = ?", [read, id], null, onError);
  });
}

function deleteRecord() {
  db.transaction(function(tx) {
    tx.executeSql("DELETE FROM Items WHERE read = trie", [],
        function(tx, result) { showRecords() }, 
        onError);
  });
}

function countUnread(fct) {
	db.transaction(function(tx) {
		tx.executeSql("SELECT * FROM Items Where read = ?", [false], fct, onError);
	});
}

// delete table from db
function dropTable() {
  db.transaction(function(tx) {
    tx.executeSql("DROP TABLE Items", [],
        function(tx) { showRecords() }, 
        onError);
  });
}

// Parseurs
function parse() {
  var feedUrl = 'http://www.lequipe.fr/Xml/actu_rss.xml';
  
  try {
	req = new XMLHttpRequest();
  } catch(e) {
    req = false;
  }
  if(req) {
    req.onload = handleResponse;
    req.onerror = handleError;
    req.open("GET", feedUrl, true);
    req.send("");
  } else {
	console.log("XMLHttpRequest failed");
  }
}

// Handles feed parsing errors.
function handleFeedParsingFailed(error) {
//TODO
  //var feed = document.getElementById("channel");
 //feed.className = "error";
  //feed.innerText = "Error: " + error;
}

// Handles errors during the XMLHttpRequest.
function handleError() {
  handleFeedParsingFailed('Failed to fetch RSS feed.');
}

// Handles parsing the feed data we got back from XMLHttpRequest.
function handleResponse() {
  var doc = req.responseXML;
  if (!doc) {
    handleFeedParsingFailed("Not a valid feed.");
    return;
  }
  xmlParser(doc);
  
}

function xmlParser(doc) {
  var i = 0;
  var itemList = [];
  $(doc).find("item").each(function() {
    var item = $(this);
    var itemToAdd = {
	  title: item.find("title").text(),
	  link: item.find("link").text(),
	  description: item.find("description").text(),
	  pubDate: item.find("pubDate").text()
	};
	console.log(itemToAdd.title);
    newRecord(itemToAdd.link, itemToAdd.title, itemToAdd.link, "rss", itemToAdd.description, true);
    itemList[i] = itemToAdd;
    i++;
  });
  return itemList;
}

function init() {
	createTable();
	parse();
}
</script>
</head>
<body onload="init();"></body>
</html>